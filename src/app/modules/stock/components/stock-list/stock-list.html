<div class="stock-list">
  <div class="log_header">
    <h2 class="titulo">Historial de Movimientos</h2>
  </div>

  <!-- Filtros + búsqueda + tamaño de página -->
  <div class="filtros">
    <div class="btns">
      <button (click)="setFiltro('todos')">Todos</button>
      <button (click)="setFiltro('ingreso')">Ingresos</button>
      <button (click)="setFiltro('egreso')">Egresos</button>
      <!-- <div class="acciones">
        <button (click)="exportTodoEnUnCSV()">Exportar CSV</button>
      </div> -->
    </div>

    <div class="busqueda">
      <input
        type="search"
        placeholder="Buscar por modelo, comentario o tipo…"
        (input)="onSearch($any($event.target).value)"
      >
      <label class="pagesize">
        por página:
        <select (change)="pageSize=+$any($event.target).value; goTo(1)">
          <option [selected]="pageSize===5"  value="5">5</option>
          <option [selected]="pageSize===10" value="10">10</option>
          <option [selected]="pageSize===25" value="25">25</option>
          <option [selected]="pageSize===50" value="50">50</option>
        </select>
      </label>
    </div>
  </div>

  <div class="tabla-container">
    <table class="tabla">
      <thead>
        <tr>
          <th (click)="onSort('fecha')">
            Fecha
            @if (sortKey==='fecha') { <span class="dir">({{sortDir}})</span> }
          </th>
          <th (click)="onSort('modelo')">
            Modelo
            <!-- @if (sortKey==='modelo') { <span class="dir">({{sortDir}})</span> } -->
          </th>
          <th (click)="onSort('tipo')">
            Movimiento
            @if (sortKey==='tipo') { <span class="dir">({{sortDir}})</span> }
          </th>
          <th (click)="onSort('comentario')">
            Comentario
            @if (sortKey==='comentario') { <span class="dir">({{sortDir}})</span> }
          </th>
        </tr>
      </thead>

      <tbody>
        @for (m of visible; track trackByMovimiento($index, m)) {
          <tr>
            <td>{{ m.fecha | date:'dd/MM/yyyy HH:mm' }}</td>
            <td>
              <span class="modelo-id" (click)="toggleExpand(m.id)">
                {{ m.nombre }}
              </span>
              @if (expanded[m.id]) {
                <ul class="exp-items" style="margin-top:0.5em;">
                  @for (it of m.items; track it.categoria) {
                    <li>
                      <strong>{{ it.categoria ? (it.categoria | categoriaNombre) : 'Cantidad' }}</strong>: x{{ it.cantidad }}
                    </li>
                  }
                </ul>
              }
            </td>
            <td>
              @if (m.tipo === 'ingreso') {
                <span class="badge ingreso">↑ Ingreso</span>
              } @else {
                <span class="badge egreso">↓ Egreso</span>
              }
            </td>
            <td>{{ m.comentario }}</td>
          </tr>
        } @empty {
          <tr><td colspan="4" class="muted">Sin resultados</td></tr>
        }
      </tbody>
    </table>
  </div>

  @if (total > pageSize) {
    <div class="pagination">
      <button (click)="goTo(1)" [disabled]="page===1">« Primero</button>
      <button (click)="goTo(page-1)" [disabled]="page===1">‹ Anterior</button>

      <span>Página {{page}} de {{ Math.ceil(total / pageSize) }}</span>

      <button (click)="goTo(page+1)" [disabled]="page>=Math.ceil(total / pageSize)">Siguiente ›</button>
      <button (click)="goTo(Math.ceil(total / pageSize))" [disabled]="page>=Math.ceil(total / pageSize)">Último »</button>
    </div>
  }
</div>
